<html>
	<head>
		<meta charset="UTF-8">
		<title>Sanatlium</title>
		<link rel="stylesheet" type="text/css" href="Sanatlium.css">
		<script type="text/javascript" src="jquery-1.4.1.min.js"></script>
		<script type="text/javascript" src="jquery.gpkey-0.1.min.js"></script>
		<script type="text/python">
			import SanatliumCore
			api_handler = SanatliumCore.TwitterAPIHandler()
		</script>
		<script type="text/javascript">
			jQuery(function(){
				//var
				var in_reply_to = ["" ,""];//0:in_reply_to_id 1:status
				
				//load last 200 Home TimeLine and reply
				var mention_html = api_handler.get_mention(200);
				jQuery("#timeline").prepend(mention_html);
				jQuery("#replytab").prepend(mention_html);
				jQuery("#timeline").prepend(api_handler.get_tl(200));
				
				//set timeline div size
				var postformheight = jQuery("#post_form").innerHeight();	
				var windowheight = jQuery(window).height();
				jQuery(".maintab").height(windowheight-postformheight-35);
				
				// set UserStreamings Event Lisetener
				setInterval(function(){
					jQuery("#timeline").prepend(api_handler.check_que());
				} ,500);
				
				
				//set UI Event Handler
				//POST button
				jQuery("#post_button").click(function(){
					if (in_reply_to[0] != ""){
						api_handler.update(jQuery("#post_status").val() ,in_reply_to[0]);
						in_reply_to = ["" ,""];
						jQuery("#in_reply_to_indicator").remove();
					}else{
						api_handler.update(jQuery("#post_status").val());
					}
					jQuery("#post_status").val("");
				});
				//reply
				jQuery(".reply").live("click",function(){
					var getAcount = jQuery(this).parents(".tweet").find(".acountname").text();
					jQuery("#post_status").text(getAcount+" ");
					jQuery("#post_status").focus();
					in_reply_to[0] = jQuery(this).parents(".tweet").attr("id");
					in_reply_to[1] = "in reply to..."+getAcount+":"+jQuery(this).parents(".tweet").find(".acounttext").text();
					jQuery("#post_form").prepend("\
						<div id='in_reply_to_indicator'>"+in_reply_to[1]+"<button id='in_reply_to_delete'>解除</button></div>\
						");
					var getAcount ="";
				});
				/*
				//Unofficial RT
				jQuery(".tweet").live("click",function(){
					var getAcount = jQuery(this).find(".acountname").text();
					var getText =jQuery(this).find(".acounttext").text();
					jQuery("#post_status").text(" RT "+getAcount+": "+getText);
					jQuery("#post_status").focus();
					var getAcount ="";
				});
				*/
				//QT
				jQuery(".QT").live("click",function(){
					var getAcount = jQuery(this).parents(".tweet").find(".acountname").text();
					var getText = jQuery(this).parents(".tweet").find(".acounttext").text();
					jQuery("#post_status").text(" QT "+getAcount+": "+getText);
					jQuery("#post_status").focus();
					in_reply_to[0] = jQuery(this).parents(".tweet").attr("id");
					in_reply_to[1] = "in reply to..."+getAcount+":"+getText;
					jQuery("#post_form").prepend("\
						<div id='in_reply_to_indicator'>"+in_reply_to[1]+"<button id='in_reply_to_delete'>解除</button></div>\
						");
					var getAcount ="";
				});
				//create favorite
				jQuery(".fav").live("click",function(){
					api_handler.create_favorite(jQuery(this).parents(".tweet").attr("id"));
					alert("favarited");
				});
				/*
				//create RT
				jQuery(".tweet").live("click",function(){
					api_handler.create_retweet(jQuery(this).attr("id"));
					alert("RTed");
				});
				*/
				//in_reply_to_indicator
				jQuery("#in_reply_to_delete").live("click" ,function(){
					in_reply_to = ["" ,""];
					jQuery("#in_reply_to_indicator").remove();
				});
				//reply bom
				jQuery(".reply_bom").live("click",function(){
				var getAcount = jQuery(this).parents(".tweet").find(".acountname").text();
				for(var z = 1; z < 10;z++){
					getAcount = getAcount+".";
					api_handler.update(jQuery(getAcount).val());
     				}
     			getAcount = "";
    			});
							
				//make tab script
				jQuery(".tab li a").click(function(){
					jQuery(".tab li a").removeClass("selected");
					jQuery(this).addClass("selected");
					jQuery(".maintab").hide();
					jQuery(jQuery(this).attr("href")).fadeIn(0);
					return false;
				});		
				
				//check if mouse cursor on timeline
				jQuery(".maintab").mouseover(function(){
					jQuery(this).focus();
				});
				
				//display string length of post_form
				jQuery("#post_status").bind("change keyup",function(){
					var WriLeng = jQuery(this).val().length;
					var Leng = 140 - WriLeng;
					jQuery("#textcount").text(Leng);
					if(Leng < 0){
						jQuery("#textcount").css("color","red");
					}else{
						jQuery("#textcount").css("color","#000");
					}
				});
				
				//set Window Resize Event Handler
				jQuery(window).resize(function(){
					windowheight = jQuery(window).height();
					jQuery(".maintab").height(windowheight-postformheight-35);
				});
				
				//set Key Config
				jQuery("#post_form").gpKey("down" ,{
					"^enter":function(){
						jQuery("#post_button").click();
					},
				});
			});
		</script>
	</head>
	
	<body>
		<div id="post_form">
			<textarea id="post_status" rows="4"></textarea><br />
			<b id="textcount">140</b><button id="post_button">POST</button>
		</div>
		<ul class="tab">
			<li><a href="#timeline" class="selected">TimeLine</a></li>
			<li><a href="#replytab">Mentions</a></li>
		</ul>
		<hr />
		<div id="timeline" class="maintab">
		</div>
		<div id="replytab" class="maintab">
		</div>
	</body>
</html>